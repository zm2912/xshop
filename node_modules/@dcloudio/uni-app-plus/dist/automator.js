var n,e=Object.prototype.hasOwnProperty,t=Array.isArray,r=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;function o(n,o){if(t(n))return n;if(o&&(i=o,u=n,e.call(i,u)))return[n];var i,u,a=[];return n.replace(r,(function(n,e,t,r){return a.push(t?r.replace(/\\(\\)?/g,"$1"):e||n),r})),a}function i(n){return n.__wxWebviewId__?n.__wxWebviewId__:n.privateProperties?n.privateProperties.slaveId:n.$page?n.$page.id:void 0}function u(n){return n.route||n.uri}function a(n){return n.options||n.$page&&n.$page.options||{}}function c(n){return{id:i(n),path:u(n),query:a(n)}}function s(n){var e=function(n){return getCurrentPages().find((function(e){return i(e)===n}))}(n);return e&&e.$vm}function f(n,e){var t=s(n);return t&&function n(e,t){var r;return e&&(!function(n,e){return function(n){if(n._$id)return n._$id;var e=function(n){for(var e=n.$parent;e;){if(e._$id)return e;e=e.$parent}}(n);if(!n.$parent)return"-1";var t=n.$vnode,r=t.context;return r&&r!==e&&r._$id?r._$id+";"+e._$id+","+t.data.attrs._i:e._$id+","+t.data.attrs._i}(n)===e}(e,t)?e.$children.find((function(e){return r=n(e,t)})):r=e),r}(t,e)}function g(n,e){var t;return n&&(t=e?function(n,e){var t,r=o(e,n);for(t=r.shift();null!=t;){if(null==(n=n[t]))return;t=r.shift()}return n}(n.$data,e):Object.assign({},n.$data)),Promise.resolve({data:t})}function d(n,e){return n&&Object.keys(e).forEach((function(t){n[t]=e[t]})),Promise.resolve()}function p(e,t,r){return new Promise((function(o,i){if(!e)return i(n.VM_NOT_EXISTS);if(!e[t])return i(n.VM_NOT_EXISTS);var u,a=e[t].apply(e,r);!(u=a)||"object"!=typeof u&&"function"!=typeof u||"function"!=typeof u.then?o({result:a}):a.then((function(n){o({result:n})}))}))}!function(n){n.VM_NOT_EXISTS="VM_NOT_EXISTS",n.METHOD_NOT_EXISTS="METHOD_NOT_EXISTS"}(n||(n={}));var l=/Sync$/;var v={getPageStack:function(){return Promise.resolve({pageStack:getCurrentPages().map((function(n){return c(n)}))})},getCurrentPage:function(){var n=getCurrentPages(),e=n.length;return new Promise((function(t,r){e?t(c(n[e-1])):r(Error("getCurrentPages().length=0"))}))},callUniMethod:function(n){var e=n.method,t=n.args;return new Promise((function(n,r){if(!uni[e])return r(Error("uni."+e+" not exists"));if(function(n){return l.test(n)}(e))return n({result:uni[e].apply(uni,t)});var o=[Object.assign({},t[0]||{},{success:function(t){setTimeout((function(){n({result:t})}),"pageScrollTo"===e?350:0)},fail:function(n){r(Error(n.errMsg.replace(e+":fail ","")))}})];uni[e].apply(uni,o)}))}},_={getData:function(n){return g(s(n.pageId),n.path)},setData:function(n){return d(s(n.pageId),n.data)},callMethod:function(e){var t,r=((t={})[n.VM_NOT_EXISTS]="Page["+e.pageId+"] not exists",t[n.METHOD_NOT_EXISTS]="page."+e.method+" not exists",t);return new Promise((function(n,t){p(s(e.pageId),e.method,e.args).then((function(e){return n(e)})).catch((function(n){t(Error(r[n]))}))}))}};function h(n){return n.nodeId||n.elementId}var m={getData:function(n){return g(f(n.pageId,h(n)),n.path)},setData:function(n){return d(f(n.pageId,h(n)),n.data)},callMethod:function(e){var t,r=h(e),o=((t={})[n.VM_NOT_EXISTS]="Component["+e.pageId+":"+r+"] not exists",t[n.METHOD_NOT_EXISTS]="component."+e.method+" not exists",t);return new Promise((function(n,t){p(f(e.pageId,r),e.method,e.args).then((function(e){return n(e)})).catch((function(n){t(Error(o[n]))}))}))}},S={};Object.keys(v).forEach((function(n){S["App."+n]=v[n]})),Object.keys(_).forEach((function(n){S["Page."+n]=_[n]})),Object.keys(m).forEach((function(n){S["Element."+n]=m[n]}));var T=process.env.UNI_AUTOMATOR_WS_ENDPOINT;setTimeout((function(){!function(n){void 0===n&&(n={}),UniServiceJSBridge.subscribe("onAutoMessageReceive",(function(n){t(n)}));var e=uni.connectSocket({url:T,complete:function(){}}),t=function(n){return e.send({data:JSON.stringify(n)})};e.onOpen((function(e){n.success&&n.success(),console.log("已开启自动化测试...")})),e.onMessage((function(n){var e=JSON.parse(n.data),r=e.id,o=e.method,i=e.params,u={id:r},a=S[o];if(!a){var c=i.pageId;if(!c){var s=getCurrentPages();s.length&&(c=s[s.length-1].$page.id)}return UniServiceJSBridge.publishHandler("sendAutoMessage",{id:r,method:o,params:i},c)}try{a(i).then((function(n){n&&(u.result=n)})).catch((function(n){u.error={message:n.message}})).finally((function(){t(u)}))}catch(n){u.error={message:n.message},t(u)}})),e.onError((function(n){console.log("automator.onError",n)})),e.onClose((function(){n.fail&&n.fail({errMsg:"$$initRuntimeAutomator:fail"}),console.log("automator.onClose")}))}()}),500);
